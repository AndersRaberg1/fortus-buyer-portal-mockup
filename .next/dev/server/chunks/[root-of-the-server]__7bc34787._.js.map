{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///Users/andersraberg/buyer-portal-mockup/src/app/api/extract-pdf/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\nimport axios from 'axios';\nimport FormData from 'form-data';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.SUPABASE_URL || '',\n  process.env.SUPABASE_SERVICE_ROLE_KEY || '' // Secret key för server-side (säker)\n);\n\nexport async function POST(req: NextRequest) {\n  const formData = await req.formData();\n  const file = formData.get('file') as File | null;\n\n  if (!file) {\n    return new Response(JSON.stringify({ error: 'Ingen fil uppladdad' }), { status: 400 });\n  }\n\n  const buffer = Buffer.from(await file.arrayBuffer());\n\n  const ocrForm = new FormData();\n  ocrForm.append('apikey', process.env.OCR_SPACE_API_KEY || '');\n  ocrForm.append('language', 'auto');\n  ocrForm.append('OCREngine', '2');\n  ocrForm.append('isTable', 'true');\n  ocrForm.append('scale', 'true');\n  ocrForm.append('detectOrientation', 'true');\n  ocrForm.append('file', buffer, {\n    filename: file.name || 'faktura.pdf',\n    contentType: file.type || 'application/pdf',\n  });\n\n  try {\n    const ocrResponse = await axios.post('https://api.ocr.space/parse/image', ocrForm, {\n      headers: ocrForm.getHeaders(),\n      timeout: 60000,\n    });\n\n    const ocrData = ocrResponse.data;\n\n    if (ocrData.IsErroredOnProcessing || ocrData.OCRExitCode !== 1) {\n      throw new Error(ocrData.ErrorMessage?.join(' ') || `OCR-fel (kod: ${ocrData.OCRExitCode})`);\n    }\n\n    const fullText = ocrData.ParsedResults.map((r: any) => r.ParsedText).join('\\n');\n\n    // Din befintliga parsing (perfekt för Telavox – kopiera från senaste fungerande version)\n\n    const parsed = {\n      amount: amount !== 'Ej hittat' ? `${amount} kr` : 'Ej hittat',\n      dueDate,\n      supplier,\n      invoiceNumber,\n      ocrNumber,\n    };\n\n    // Spara PDF i Storage\n    const fileName = `faktura_${Date.now()}.pdf`;\n    const { error: storageError } = await supabase.storage\n      .from('invoices')\n      .upload(fileName, buffer, {\n        contentType: 'application/pdf',\n        upsert: false,\n      });\n\n    if (storageError) throw storageError;\n\n    const { data: { publicUrl } } = supabase.storage.from('invoices').getPublicUrl(fileName);\n\n    // Spara i tabell\n    const { error: dbError } = await supabase\n      .from('invoices')\n      .insert({ parsed_data: parsed, pdf_url: publicUrl });\n\n    if (dbError) throw dbError;\n\n    return new Response(JSON.stringify({\n      parsed,\n      message: 'Faktura sparad i Supabase!',\n      pdfUrl: publicUrl,\n    }), { status: 200 });\n  } catch (err: any) {\n    console.error('Error:', err.message);\n    return new Response(JSON.stringify({ error: err.message || 'Misslyckades' }), { status: 500 });\n  }\n}"],"names":[],"mappings":";;;;AACA;AACA;AACA;;;;AAEA,MAAM,WAAW,IAAA,6NAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,IAAI,IAC5B,QAAQ,GAAG,CAAC,yBAAyB,IAAI,GAAG,qCAAqC;;AAG5E,eAAe,KAAK,GAAgB;IACzC,MAAM,WAAW,MAAM,IAAI,QAAQ;IACnC,MAAM,OAAO,SAAS,GAAG,CAAC;IAE1B,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,OAAO;QAAsB,IAAI;YAAE,QAAQ;QAAI;IACtF;IAEA,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;IAEjD,MAAM,UAAU,IAAI,0LAAQ;IAC5B,QAAQ,MAAM,CAAC,UAAU,QAAQ,GAAG,CAAC,iBAAiB,IAAI;IAC1D,QAAQ,MAAM,CAAC,YAAY;IAC3B,QAAQ,MAAM,CAAC,aAAa;IAC5B,QAAQ,MAAM,CAAC,WAAW;IAC1B,QAAQ,MAAM,CAAC,SAAS;IACxB,QAAQ,MAAM,CAAC,qBAAqB;IACpC,QAAQ,MAAM,CAAC,QAAQ,QAAQ;QAC7B,UAAU,KAAK,IAAI,IAAI;QACvB,aAAa,KAAK,IAAI,IAAI;IAC5B;IAEA,IAAI;QACF,MAAM,cAAc,MAAM,+KAAK,CAAC,IAAI,CAAC,qCAAqC,SAAS;YACjF,SAAS,QAAQ,UAAU;YAC3B,SAAS;QACX;QAEA,MAAM,UAAU,YAAY,IAAI;QAEhC,IAAI,QAAQ,qBAAqB,IAAI,QAAQ,WAAW,KAAK,GAAG;YAC9D,MAAM,IAAI,MAAM,QAAQ,YAAY,EAAE,KAAK,QAAQ,CAAC,cAAc,EAAE,QAAQ,WAAW,CAAC,CAAC,CAAC;QAC5F;QAEA,MAAM,WAAW,QAAQ,aAAa,CAAC,GAAG,CAAC,CAAC,IAAW,EAAE,UAAU,EAAE,IAAI,CAAC;QAE1E,yFAAyF;QAEzF,MAAM,SAAS;YACb,QAAQ,WAAW,cAAc,GAAG,OAAO,GAAG,CAAC,GAAG;YAClD;YACA;YACA;YACA;QACF;QAEA,sBAAsB;QACtB,MAAM,WAAW,CAAC,QAAQ,EAAE,KAAK,GAAG,GAAG,IAAI,CAAC;QAC5C,MAAM,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,SAAS,OAAO,CACnD,IAAI,CAAC,YACL,MAAM,CAAC,UAAU,QAAQ;YACxB,aAAa;YACb,QAAQ;QACV;QAEF,IAAI,cAAc,MAAM;QAExB,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,EAAE,GAAG,SAAS,OAAO,CAAC,IAAI,CAAC,YAAY,YAAY,CAAC;QAE/E,iBAAiB;QACjB,MAAM,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,YACL,MAAM,CAAC;YAAE,aAAa;YAAQ,SAAS;QAAU;QAEpD,IAAI,SAAS,MAAM;QAEnB,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YACjC;YACA,SAAS;YACT,QAAQ;QACV,IAAI;YAAE,QAAQ;QAAI;IACpB,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,UAAU,IAAI,OAAO;QACnC,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,OAAO,IAAI,OAAO,IAAI;QAAe,IAAI;YAAE,QAAQ;QAAI;IAC9F;AACF"}}]
}